<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketing Analytics Dashboard</title>
  <!-- Include React and ReactDOM -->
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <!-- Include Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Include Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Include Lodash -->
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <!-- Include Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
    /* Include all your styles here - same as before */
    body {
      background-color: rgba(20, 19, 28, 0.7);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    
    /* Container styling with transparent white stroke */
    .dashboard-container {
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.05);
      background-color: rgba(20, 19, 28, 0.3);
      backdrop-filter: blur(10px);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .dashboard-widget {
      background-color: rgba(36, 35, 49, 0.5);
      border-left: 3px solid rgba(136, 84, 208, 0.8);
    }
    
    .dashboard-widget:hover {
      background-color: rgba(36, 35, 49, 0.7);
    }
    
    /* Status badge styling */
    .status-badge {
      background-color: white !important;
      border: 1px solid rgba(136, 84, 208, 0.4) !important;
      color: rgb(136, 84, 208) !important;
      font-weight: 500;
      padding: 2px 8px;
      white-space: normal;
      display: inline-block;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Header styling for consistency */
    .header-container {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background-color: rgba(0, 0, 0, 0.2);
    }
    
    /* Card styling */
    .dashboard-card {
      border: 1px solid rgba(255, 255, 255, 0.1);
      background-color: rgba(36, 35, 49, 0.5);
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.2s ease;
    }
    
    .dashboard-card:hover {
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    /* Button styling */
    .dashboard-button {
      background-color: transparent;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      transition: all 0.2s ease;
    }
    
    .dashboard-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    /* Table styling */
    .dashboard-table th,
    .dashboard-table td {
      padding: 0.75rem 1rem;
      text-align: left;
    }
    
    .dashboard-table th {
      background-color: rgba(0, 0, 0, 0.2);
      font-weight: 500;
      cursor: pointer;
    }
    
    .dashboard-table tr {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .dashboard-table tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    /* Metric card styling */
    .metric-card {
      background-color: rgba(36, 35, 49, 0.7);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 1rem;
    }
    
    .metric-value {
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .metric-label {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.6);
    }
    
    /* Chart containers */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    
    /* Loading state */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 4px solid rgba(136, 84, 208, 0.8);
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Error state */
    .error-container {
      background-color: rgba(220, 38, 38, 0.2);
      border: 1px solid rgba(220, 38, 38, 0.5);
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }
  </style>
</head>
<body class="bg-transparent">
  <div id="root" class="min-h-screen py-8"></div>

  <script type="text/babel">
    // Import React hooks
    const { useState, useEffect, useRef } = React;
    
    // Neon API configuration
    const NEON_API_KEY = 'napi_xai0wdd9ir8ry0wdz2uhy68u8dmwewg6uun4eem8hbdwzm81h4hu0vf51s1qw08u';
    const NEON_PROJECT_ID = 'ep-frosty-river-a5nxmr1x-pooler';
    const NEON_DATABASE = 'neondb';
    
    // Utility functions (formatCurrency, formatPercentage, etc.) 
    // ...same as your original code...
    const formatCurrency = (value) => {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2
      }).format(value);
    };
    
    const formatPercentage = (value) => {
      return new Intl.NumberFormat('en-US', {
        style: 'percent',
        minimumFractionDigits: 1,
        maximumFractionDigits: 1
      }).format(value / 100);
    };
    
    const formatNumber = (value) => {
      return new Intl.NumberFormat('en-US').format(value);
    };
    
    const formatDate = (dateStr) => {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric'
      });
    };
    
    // Helper for sorting data
    const sortData = (data, sortField, sortDirection) => {
      return [...data].sort((a, b) => {
        const valueA = a[sortField];
        const valueB = b[sortField];
        
        // Handle numeric values
        if (!isNaN(valueA) && !isNaN(valueB)) {
          return sortDirection === 'asc' ? valueA - valueB : valueB - valueA;
        }
        
        // Handle date values
        if (valueA instanceof Date && valueB instanceof Date) {
          return sortDirection === 'asc' ? valueA - valueB : valueB - valueA;
        }
        
        // Handle string values
        const stringA = String(valueA).toLowerCase();
        const stringB = String(valueB).toLowerCase();
        return sortDirection === 'asc' 
          ? stringA.localeCompare(stringB) 
          : stringB.localeCompare(stringA);
      });
    };
    
    // Function to execute SQL query via Neon API
    const executeQuery = async (query) => {
      try {
        const response = await fetch(`https://console.neon.tech/api/v2/projects/${NEON_PROJECT_ID}/branches/main/query`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${NEON_API_KEY}`
          },
          body: JSON.stringify({
            query: query
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`Neon API error: ${errorData.message || response.status}`);
        }
        
        const data = await response.json();
        return data.rows || [];
      } catch (error) {
        console.error('Error executing query:', error);
        throw error;
      }
    };
    
    // Main Dashboard Component
    const MarketingDashboard = () => {
      const [listGrowthData, setListGrowthData] = useState([]);
      const [campaignData, setCampaignData] = useState([]);
      const [flowData, setFlowData] = useState([]);
      const [revenueData, setRevenueData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [lastUpdated, setLastUpdated] = useState(null);
      const [activeTab, setActiveTab] = useState('overview');
      
      // Function to fetch data from Neon
      const fetchDashboardData = async () => {
        try {
          setLoading(true);
          setError(null);
          
          // Query list growth data
          const listGrowthQuery = `
            SELECT 
              id, 
              date, 
              net_members_changed, 
              total_members, 
              members_removed,
              members_added
            FROM listgrowth
            WHERE date >= NOW() - INTERVAL '30 days'
            ORDER BY date ASC
          `;
          
          // Query campaign data
          const campaignsQuery = `
            SELECT 
              id, 
              campaignname, 
              send_time, 
              subject, 
              channel, 
              average_order_value, 
              click_rate, 
              conversion_rate, 
              conversion_value,
              open_rate, 
              recipients, 
              revenue_per_recipient
            FROM campaigns
            WHERE send_time >= NOW() - INTERVAL '30 days'
            ORDER BY send_time DESC
          `;
          
          // Query flow data
          const flowsQuery = `
            SELECT 
              id, 
              flow_name, 
              email_name, 
              subject,
              average_order_value, 
              click_rate, 
              conversion_rate, 
              conversion_value,
              recipients, 
              revenue_per_recipient, 
              status
            FROM flows
          `;
          
          // Query revenue data
          const revenueQuery = `
            SELECT 
              SUM(email_rev::numeric) as email_rev,
              SUM(sms_rev::numeric) as sms_rev,
              SUM(total_rev::numeric) as total_rev,
              SUM(flow_email_rev::numeric) as flow_email_rev,
              SUM(flow_sms_rev::numeric) as flow_sms_rev,
              SUM(campaign_email_rev::numeric) as campaign_email_rev,
              SUM(campaign_sms_rev::numeric) as campaign_sms_rev
            FROM storedata
            WHERE date >= NOW() - INTERVAL '30 days'
          `;
          
          // Execute all queries in parallel
          const [listGrowthResult, campaignsResult, flowsResult, revenueResult] = await Promise.all([
            executeQuery(listGrowthQuery),
            executeQuery(campaignsQuery),
            executeQuery(flowsQuery),
            executeQuery(revenueQuery)
          ]);
          
          // Process and set data
          if (listGrowthResult && listGrowthResult.length > 0) {
            setListGrowthData(listGrowthResult.map(item => ({
              ...item,
              date: new Date(item.date)
            })));
          }
          
          if (campaignsResult && campaignsResult.length > 0) {
            setCampaignData(campaignsResult.map(item => ({
              ...item,
              send_time: new Date(item.send_time)
            })));
          }
          
          if (flowsResult && flowsResult.length > 0) {
            setFlowData(flowsResult);
          }
          
          if (revenueResult && revenueResult.length > 0) {
            setRevenueData(revenueResult[0]);
          }
          
          setLastUpdated(new Date());
          
        } catch (error) {
          console.error('Error fetching dashboard data:', error);
          setError(error.message);
          
          // Fallback to mock data if there's an error
          if (listGrowthData.length === 0 && campaignData.length === 0 && 
              flowData.length === 0 && !revenueData) {
            generateMockData();
          }
        } finally {
          setLoading(false);
        }
      };
      
      // Rest of your code (generateMockData, useEffect, etc.) stays the same
      // Including the component rendering JSX
      // ... 
      
      // Generate mock data as fallback
      const generateMockData = () => {
        console.log("Generating mock data");
        
        // Generate mock list growth data
        const mockListGrowth = Array.from({ length: 30 }, (_, i) => {
          const date = new Date();
          date.setDate(date.getDate() - (29 - i));
          
          const baseMembers = 10000;
          const dailyGrowth = Math.floor(Math.random() * 200) - 50; // Between -50 and 150
          const dailyAdded = Math.max(0, Math.floor(Math.random() * 150) + 50); // Between 50 and 200
          const dailyRemoved = Math.max(0, dailyAdded - dailyGrowth); // Ensures net change matches
          
          return {
            date: date,
            total_members: baseMembers + (i * 50) + dailyGrowth,
            net_members_changed: dailyGrowth,
            members_added: dailyAdded,
            members_removed: dailyRemoved
          };
        });
        
        setListGrowthData(mockListGrowth);
        
        // Generate mock campaign data
        const channels = ['email', 'sms'];
        const mockCampaigns = Array.from({ length: 10 }, (_, i) => {
          const date = new Date();
          date.setDate(date.getDate() - Math.floor(Math.random() * 30));
          
          const channel = channels[Math.floor(Math.random() * channels.length)];
          const recipients = Math.floor(Math.random() * 5000) + 1000;
          const openRate = Math.random() * 40 + 10; // 10-50%
          const clickRate = Math.random() * 15 + 5; // 5-20%
          const convRate = Math.random() * 5 + 1; // 1-6%
          const avgOrderValue = Math.random() * 70 + 30; // $30-$100
          
          return {
            id: `campaign-${i}`,
            campaignname: `${channel === 'email' ? 'Email' : 'SMS'} Campaign ${i + 1}`,
            send_time: date,
            subject: `Special offer ${i + 1}`,
            channel: channel,
            recipients: recipients,
            open_rate: openRate,
            click_rate: clickRate,
            conversion_rate: convRate,
            average_order_value: avgOrderValue,
            conversion_value: (recipients * convRate / 100 * avgOrderValue),
            revenue_per_recipient: ((recipients * convRate / 100 * avgOrderValue) / recipients)
          };
        });
        
        setCampaignData(mockCampaigns);
        
        // Generate mock flow data
        const flowTypes = ['Welcome', 'Abandoned Cart', 'Browse Abandonment', 'Post-Purchase', 'Winback'];
        const statuses = ['Active', 'Paused', 'Draft'];
        
        const mockFlows = Array.from({ length: 8 }, (_, i) => {
          const flowType = flowTypes[Math.floor(Math.random() * flowTypes.length)];
          const recipients = Math.floor(Math.random() * 3000) + 500;
          const clickRate = Math.random() * 20 + 10; // 10-30%
          const convRate = Math.random() * 8 + 2; // 2-10%
          const avgOrderValue = Math.random() * 70 + 30; // $30-$100
          
          return {
            id: `flow-${i}`,
            flow_name: `${flowType} Flow`,
            email_name: `${flowType} Email ${i + 1}`,
            subject: `${flowType} Follow-up`,
            status: statuses[Math.floor(Math.random() * statuses.length)],
            recipients: recipients,
            click_rate: clickRate,
            conversion_rate: convRate,
            conversion_value: (recipients * convRate / 100 * avgOrderValue),
            revenue_per_recipient: ((recipients * convRate / 100 * avgOrderValue) / recipients)
          };
        });
        
        setFlowData(mockFlows);
        
        // Generate mock revenue data
        const totalRev = Math.random() * 50000 + 30000; // $30k-$80k
        const emailRev = totalRev * (Math.random() * 0.3 + 0.5); // 50-80% of total
        const smsRev = totalRev - emailRev;
        
        const flowEmailRev = emailRev * (Math.random() * 0.3 + 0.35); // 35-65% of email revenue
        const campaignEmailRev = emailRev - flowEmailRev;
        
        const flowSmsRev = smsRev * (Math.random() * 0.3 + 0.35); // 35-65% of sms revenue
        const campaignSmsRev = smsRev - flowSmsRev;
        
        const mockRevenue = {
          total_rev: totalRev,
          email_rev: emailRev,
          sms_rev: smsRev,
          flow_email_rev: flowEmailRev,
          flow_sms_rev: flowSmsRev,
          campaign_email_rev: campaignEmailRev,
          campaign_sms_rev: campaignSmsRev
        };
        
        setRevenueData(mockRevenue);
        setLastUpdated(new Date());
      };
      
      // Initial data load
      useEffect(() => {
        fetchDashboardData();
        
        // Schedule daily refresh at 9am EST
        const scheduleRefresh = () => {
          const now = new Date();
          const estOffset = -4 * 60; // EST is UTC-4 (in minutes)
          const utcMinutes = now.getUTCHours() * 60 + now.getUTCMinutes();
          const estMinutes = (utcMinutes + estOffset + 24 * 60) % (24 * 60);
          
          const targetMinutes = 9 * 60; // 9am = 9 * 60 minutes
          let minutesUntilTarget = targetMinutes - estMinutes;
          if (minutesUntilTarget <= 0) {
            minutesUntilTarget += 24 * 60; // Add a day if target is in the past
          }
          
          const msUntilTarget = minutesUntilTarget * 60 * 1000;
          
          setTimeout(() => {
            fetchDashboardData();
            scheduleRefresh(); // Schedule the next day's refresh
          }, msUntilTarget);
        };
        
        scheduleRefresh();
        
        // Add hourly refresh for more up-to-date data
        const hourlyRefresh = setInterval(() => {
          fetchDashboardData();
        }, 60 * 60 * 1000); // Every hour
        
        return () => clearInterval(hourlyRefresh); // Clean up on unmount
      }, []);
      
      // Manual refresh button handler
      const handleRefresh = () => {
        fetchDashboardData();
      };
      
      return (
        <div className="container mx-auto p-4">
          <div className="dashboard-container">
            <div className="p-6 bg-transparent text-white header-container">
              <div className="flex justify-between items-center">
                <h1 className="text-2xl font-bold">MARKETING ANALYTICS DASHBOARD</h1>
                <div className="flex flex-col items-end">
                  <div className="flex items-center text-sm text-gray-400">
                    <span>Last Updated: {lastUpdated ? lastUpdated.toLocaleString() : 'N/A'}</span>
                    <button 
                      onClick={handleRefresh}
                      className="ml-3 dashboard-button p-1 rounded"
                      disabled={loading}
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                      </svg>
                    </button>
                  </div>
                  <div className="flex space-x-2 mt-2">
                    <button 
                      onClick={() => setActiveTab('overview')} 
                      className={`px-4 py-2 rounded transition-all ${activeTab === 'overview' ? 'border-b-2 border-purple-500 bg-transparent' : 'bg-transparent'}`}
                    >
                      Overview
                    </button>
                    <button 
                      onClick={() => setActiveTab('campaigns')} 
                      className={`px-4 py-2 rounded transition-all ${activeTab === 'campaigns' ? 'border-b-2 border-purple-500 bg-transparent' : 'bg-transparent'}`}
                    >
                      Campaigns
                    </button>
                    <button 
                      onClick={() => setActiveTab('flows')} 
                      className={`px-4 py-2 rounded transition-all ${activeTab === 'flows' ? 'border-b-2 border-purple-500 bg-transparent' : 'bg-transparent'}`}
                    >
                      Flows
                    </button>
                    <button 
                      onClick={() => setActiveTab('list')} 
                      className={`px-4 py-2 rounded transition-all ${activeTab === 'list' ? 'border-b-2 border-purple-500 bg-transparent' : 'bg-transparent'}`}
                    >
                      List Growth
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            {error && (
              <div className="error-container mx-6 text-white">
                <div className="flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                  <p className="font-bold">Error: {error}</p>
                </div>
                <p className="mt-1 ml-8">Using cached or mock data instead. Click refresh to try again.</p>
              </div>
            )}
            
            <div className="relative">
              {loading && (
                <div className="loading-overlay">
                  <div className="spinner"></div>
                </div>
              )}
              
              {/* Tabs content would go here - same as your original code */}
              {/* Just reuse all your tab content components from the original dashboard */}
            </div>
          </div>
          
          <div className="mt-4 p-2 text-center text-gray-500 text-xs">
            Data refreshes automatically at 9:00 AM EST daily
            <div className="mt-1">Using Neon API directly with API key {NEON_API_KEY.substring(0, 10)}...</div>
          </div>
        </div>
      );
    };
    
    // Initialize by rendering the dashboard component
    ReactDOM.render(
      <MarketingDashboard />,
      document.getElementById('root')
    );
  </script>
</body>
</html>
