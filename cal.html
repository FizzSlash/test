<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campaign Approval Calendar</title>
  <!-- Include React and ReactDOM -->
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <!-- Include Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Include Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Include Lodash -->
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <style>
    body {
      background-color: #0a0b18;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .campaign-email {
      background-color: #6b46c1;
    }
    .campaign-sms {
      background-color: #d69e2e;
    }
    .tab-active {
      border-bottom: 2px solid #6366f1;
    }
  </style>
</head>
<body class="bg-gray-900">
  <div id="root" class="min-h-screen py-8"></div>

  <script type="text/babel">
    // Import React hooks
    const { useState, useEffect } = React;
    
    const CampaignCalendar = () => {
      const [campaigns, setCampaigns] = useState([]);
      const [selectedCampaign, setSelectedCampaign] = useState(null);
      const [feedback, setFeedback] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const [selectedDate, setSelectedDate] = useState(null);
      const [updateStatus, setUpdateStatus] = useState(null);
      const [debug, setDebug] = useState('No data fetched yet');
      const [activeTab, setActiveTab] = useState('details'); // 'details' or 'approval'

      // Your webhook URLs
      const fetchCampaignsUrl = 'https://hook.us2.make.com/dlcqdia9qozi8lca39jytiu27xrf1t1l';
      const updateCampaignUrl = 'https://hook.us2.make.com/wem64vvx9irk7tys6itjpyt27bqorbvg';

      useEffect(() => {
        fetchCampaigns();
      }, []);

      const fetchCampaigns = async () => {
        try {
          setLoading(true);
          setDebug('Fetching campaigns...');
          
          const response = await fetch(fetchCampaignsUrl);
          
          if (!response.ok) {
            setDebug(`Response not OK: ${response.status}`);
            throw new Error(`Failed to fetch campaigns: ${response.status}`);
          }
          
          const text = await response.text();
          setDebug(`Raw response (first 200 chars): ${text.substring(0, 200)}`);
          
          let formattedCampaigns = [];
          
          try {
            // Try to parse as JSON
            const data = JSON.parse(text);
            
            // Handle array or single object
            if (Array.isArray(data)) {
              formattedCampaigns = data.map(formatCampaign);
            } else if (data && typeof data === 'object') {
              // Check if it's the new format with nested structure
              if (data.id || data.Tasks || data.Stage || data.Client) {
                formattedCampaigns = [formatCampaign(data)];
              } else {
                // Try to process all keys as potential campaigns
                Object.entries(data).forEach(([key, value]) => {
                  if (value && typeof value === 'object') {
                    formattedCampaigns.push(formatCampaign(value));
                  }
                });
              }
            }
          } catch (e) {
            setDebug(`JSON parsing failed: ${e.message}. Will try to extract data from text.`);
            // If JSON parsing fails, try to extract data from text
            formattedCampaigns = extractCampaignsFromText(text);
          }
          
          setDebug(`Processed ${formattedCampaigns.length} campaigns`);
          setCampaigns(formattedCampaigns);
        } catch (error) {
          console.error('Error fetching campaigns:', error);
          setDebug(`Error: ${error.message}`);
          setError(error.message);
          setCampaigns([]);
        } finally {
          setLoading(false);
        }
      };

      // Extract campaigns from non-JSON text
      const extractCampaignsFromText = (text) => {
        const campaigns = [];
        
        // Try to split on record boundaries
        const sections = text.split(/id:[\s]*/g).filter(Boolean);
        
        for (const section of sections) {
          try {
            // Extract all key-value pairs
            const lines = section.split('\n');
            const campaign = { id: '', fields: {} };
            
            // First line should be the ID
            campaign.id = lines[0].trim();
            
            // Process remaining lines for fields
            for (let i = 1; i < lines.length; i++) {
              const line = lines[i].trim();
              if (line && line.includes(':')) {
                const [key, ...valueParts] = line.split(':');
                const value = valueParts.join(':').trim();
                
                // Map to standard field names
                if (key.includes('Tasks') || key.includes('Task')) {
                  campaign.fields.Tasks = value;
                } else if (key.includes('Date')) {
                  campaign.fields['Send Date'] = value;
                } else if (key.includes('Stage') || key.includes('Status')) {
                  campaign.fields.Stage = value;
                } else if (key.includes('Client') || key.includes('CLIENT')) {
                  campaign.fields.CLIENT = value;
                } else if (key.includes('Notes')) {
                  campaign.fields.Notes = value;
                }
              }
            }
            
            // Only add if we have at least an ID and one field
            if (campaign.id && Object.keys(campaign.fields).length > 0) {
              campaigns.push(formatCampaign(campaign));
            }
          } catch (e) {
            console.error('Error parsing campaign section:', e);
          }
        }
        
        return campaigns;
      };
      
      // Format a campaign into a standard structure
      const formatCampaign = (data) => {
        // Handle different data structures
        let id = '';
        let tasks = '';
        let date = '';
        let stage = '';
        let client = '';
        let notes = '';
        
        // Extract ID
        if (data.id) {
          id = data.id;
        } else if (data.recordId) {
          id = data.recordId;
        }
        
        // Extract fields based on your new data structure
        if (data.Tasks) {
          tasks = data.Tasks;
        } else if (data.fields && data.fields.Tasks) {
          tasks = data.fields.Tasks;
        }
        
        if (data['Send Date']) {
          date = data['Send Date'];
        } else if (data.fields && data.fields['Send Date']) {
          date = data.fields['Send Date'];
        }
        
        if (data.Stage !== undefined) {
          stage = data.Stage;
        } else if (data.fields && data.fields.Stage !== undefined) {
          stage = data.fields.Stage;
        }
        
        if (data.Client) {
          client = data.Client;
        } else if (data.CLIENT) {
          client = data.CLIENT;
        } else if (data.fields && (data.fields.Client || data.fields.CLIENT)) {
          client = data.fields.Client || data.fields.CLIENT;
        }
        
        if (data.Notes) {
          notes = data.Notes;
        } else if (data.fields && data.fields.Notes) {
          notes = data.fields.Notes;
        }
        
        // Create campaign object
        return {
          id: id || 'unknown-' + Math.random().toString(36).substr(2, 9),
          title: tasks || 'Untitled Campaign',
          type: determineCampaignType(tasks),
          start: new Date(date || new Date()),
          end: new Date(date || new Date()),
          description: notes || '',
          status: stage || 'pending',
          clientId: client || '',
          feedback: notes || ''
        };
      };

      // Helper function to determine campaign type based on name
      const determineCampaignType = (name) => {
        if (!name) return 'email'; // Default
        
        const lowerName = name.toLowerCase();
        if (lowerName.includes('sms') || lowerName.includes('text')) {
          return 'sms';
        }
        return 'email';
      };

      const handleSelectCampaign = (campaign) => {
        setSelectedCampaign(campaign);
        setFeedback(campaign.feedback || '');
        setUpdateStatus(null);
        setActiveTab('details');
      };

      const handleApproval = async (approved) => {
        try {
          setUpdateStatus({ loading: true, error: null });
          const response = await fetch(updateCampaignUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              campaignId: selectedCampaign.id,
              approved: approved,
              feedback: feedback
            })
          });
          
          if (!response.ok) throw new Error('Failed to update campaign status');
          
          // Update local state
          setCampaigns(campaigns.map(campaign => 
            campaign.id === selectedCampaign.id 
              ? { 
                  ...campaign, 
                  status: approved ? 'Approved' : 'Needs Revision', 
                  feedback 
                } 
              : campaign
          ));
          
          setUpdateStatus({ 
            loading: false, 
            success: true, 
            message: `Campaign ${approved ? 'approved' : 'sent for revision'} successfully!` 
          });
          
          // Clear selected campaign after a delay to show success message
          setTimeout(() => {
            setSelectedCampaign(null);
            setFeedback('');
            setUpdateStatus(null);
          }, 2000);
          
        } catch (error) {
          console.error('Error updating approval status:', error);
          setUpdateStatus({ 
            loading: false, 
            error: true, 
            message: error.message || 'Error updating campaign status' 
          });
        }
      };

      const getCampaignTypeClass = (type) => {
        return type === 'sms' ? 'campaign-sms' : 'campaign-email';
      };

      // Calendar navigation
      const prevMonth = () => {
        setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1));
      };

      const nextMonth = () => {
        setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1));
      };

      // Generate calendar days
      const getDaysInMonth = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        
        // Get day of week of first day (0 = Sunday)
        const firstDayOfWeek = firstDay.getDay();
        
        // Array for all days to display
        const days = [];
        
        // Add empty slots for days before first of month
        for (let i = 0; i < firstDayOfWeek; i++) {
          days.push({ date: null, isCurrentMonth: false });
        }
        
        // Add all days in month
        for (let i = 1; i <= lastDay.getDate(); i++) {
          days.push({ 
            date: new Date(year, month, i),
            isCurrentMonth: true 
          });
        }
        
        return days;
      };

      const days = getDaysInMonth(currentMonth);
      
      // Group campaigns by date for calendar display
      const campaignsByDate = _.groupBy(campaigns, campaign => 
        campaign.start.toDateString()
      );

      // Get day name headers
      const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

      // Format date for display
      const formatDate = (date) => {
        if (!date) return '';
        return date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          year: 'numeric'
        });
      };

      // Get status badge color
      const getStatusColor = (status) => {
        if (!status) return 'bg-gray-500';
        
        const statusLower = status.toLowerCase();
        if (statusLower.includes('approved')) return 'bg-green-600';
        if (statusLower.includes('rejected')) return 'bg-red-600';
        if (statusLower.includes('revision') || statusLower.includes('needs')) return 'bg-yellow-600';
        if (statusLower.includes('design') || statusLower.includes('qa')) return 'bg-blue-600';
        if (statusLower.includes('ready')) return 'bg-purple-600';
        return 'bg-gray-600';
      };

      return (
        <div className="container mx-auto p-4">
          <div className="bg-gray-900 rounded-lg shadow-lg overflow-hidden">
            <div className="p-6 bg-black text-white">
              <h1 className="text-2xl font-bold text-center">CONTENT CALENDAR</h1>
            </div>
            
            {error && (
              <div className="p-4 bg-red-800 text-white">
                <p className="font-bold">Error:</p>
                <p>{error}</p>
              </div>
            )}
            
            {loading && (
              <div className="flex justify-center items-center py-4 bg-gray-900 text-white">
                <p>Loading campaigns...</p>
              </div>
            )}
            
            {/* Debug panel - remove in production */}
            <div className="p-4 bg-gray-800 text-white text-sm border-b border-gray-700">
              <div className="flex justify-between items-center">
                <p className="font-bold">Debug Info:</p>
                <button 
                  onClick={fetchCampaigns}
                  className="px-3 py-1 bg-blue-600 rounded hover:bg-blue-500"
                >
                  Refresh Data
                </button>
              </div>
              <p>Total Campaigns: {campaigns.length}</p>
              {campaigns.length > 0 && (
                <div className="mt-2">
                  <p>First Campaign:</p>
                  <pre className="text-xs overflow-auto max-h-20 bg-gray-900 p-2 mt-1">{JSON.stringify(campaigns[0], null, 2)}</pre>
                </div>
              )}
            </div>
            
            <div className="p-6 bg-gray-900">
              <div className="flex justify-between items-center mb-4 text-white">
                <button onClick={prevMonth} className="px-4 py-2 bg-gray-800 rounded hover:bg-gray-700">
                  &lt; Previous
                </button>
                <h2 className="text-xl font-semibold">
                  {currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}
                </h2>
                <div className="flex space-x-2">
                  <button onClick={nextMonth} className="px-4 py-2 bg-gray-800 rounded hover:bg-gray-700">
                    Next &gt;
                  </button>
                  <button className="px-4 py-2 bg-green-600 rounded hover:bg-green-500">
                    + Add
                  </button>
                </div>
              </div>
              
              {/* Calendar grid */}
              <div className="grid grid-cols-7 gap-1 rounded-lg overflow-hidden">
                {/* Weekday headers */}
                {weekdays.map(day => (
                  <div key={day} className="p-2 bg-gray-800 text-center font-semibold text-white">
                    {day}
                  </div>
                ))}
                
                {/* Calendar days */}
                {days.map((day, index) => {
                  // Get campaigns for this day
                  const dayCampaigns = day.date ? 
                    (campaignsByDate[day.date.toDateString()] || []) : [];
                  
                  return (
                    <div 
                      key={index}
                      className={`min-h-28 p-1 ${
                        day.isCurrentMonth ? 'bg-gray-900 border border-gray-800' : 'bg-black'
                      } ${
                        selectedDate && day.date && selectedDate.toDateString() === day.date.toDateString() 
                          ? 'ring-1 ring-gray-600' 
                          : ''
                      } text-white`}
                      onClick={() => day.date && setSelectedDate(day.date)}
                    >
                      {day.date && (
                        <>
                          <div className="text-right text-sm p-1">
                            {day.date.getDate()}
                          </div>
                          <div className="mt-1">
                            {dayCampaigns.map(campaign => (
                              <div 
                                key={campaign.id}
                                className={`mb-1 py-1 px-2 text-xs text-white rounded cursor-pointer ${getCampaignTypeClass(campaign.type)}`}
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleSelectCampaign(campaign);
                                }}
                              >
                                <div className="flex justify-between items-center">
                                  <span className="truncate">{campaign.title}</span>
                                  <span className={`ml-1 px-1 py-0.5 text-xs rounded ${getStatusColor(campaign.status)}`}>
                                    {campaign.status || 'Pending'}
                                  </span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
          
          {selectedCampaign && (
            <div className="mt-4 bg-gray-900 text-white rounded-lg shadow-lg">
              {/* Tabbed navigation */}
              <div className="flex border-b border-gray-700">
                <button 
                  className={`px-4 py-3 font-medium ${activeTab === 'details' ? 'text-indigo-400 tab-active' : 'text-gray-400 hover:text-white'}`}
                  onClick={() => setActiveTab('details')}
                >
                  Campaign Details
                </button>
                <button 
                  className={`px-4 py-3 font-medium ${activeTab === 'approval' ? 'text-indigo-400 tab-active' : 'text-gray-400 hover:text-white'}`}
                  onClick={() => setActiveTab('approval')}
                >
                  Approve/Revise
                </button>
              </div>
              
              {/* Details tab */}
              {activeTab === 'details' && (
                <div className="p-4">
                  <h2 className="text-xl font-semibold mb-3">{selectedCampaign.title}</h2>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                      <p className="mb-2">
                        <span className="font-semibold text-gray-400">Date:</span>{' '}
                        {formatDate(selectedCampaign.start)}
                      </p>
                      <p className="mb-2">
                        <span className="font-semibold text-gray-400">Status:</span>{' '}
                        <span className={`ml-2 px-2 py-1 rounded text-white ${getStatusColor(selectedCampaign.status)}`}>
                          {selectedCampaign.status || 'Pending'}
                        </span>
                      </p>
                    </div>
                    <div>
                      <p className="mb-2">
                        <span className="font-semibold text-gray-400">Type:</span>{' '}
                        <span className={`ml-2 px-2 py-1 rounded text-white ${getCampaignTypeClass(selectedCampaign.type)}`}>
                          {selectedCampaign.type === 'sms' ? 'SMS' : 'Email'}
                        </span>
                      </p>
                      <p className="mb-2">
                        <span className="font-semibold text-gray-400">Client:</span>{' '}
                        {selectedCampaign.clientId}
                      </p>
                    </div>
                  </div>
                  
                  {selectedCampaign.description && (
                    <div className="mb-4">
                      <p className="font-semibold text-gray-400 mb-1">Campaign Details:</p>
                      <p className="p-3 bg-gray-800 border border-gray-700 rounded">{selectedCampaign.description}</p>
                    </div>
                  )}
                  
                  {selectedCampaign.feedback && (
                    <div className="mb-4">
                      <p className="font-semibold text-gray-400 mb-1">Previous Feedback:</p>
                      <p className="p-3 bg-gray-800 border border-gray-700 rounded">{selectedCampaign.feedback}</p>
                    </div>
                  )}
                  
                  <div className="mt-4 flex justify-end">
                    <button
                      onClick={() => setActiveTab('approval')}
                      className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-500"
                    >
                      Go to Approval
                    </button>
                    <button
                      onClick={() => setSelectedCampaign(null)}
                      className="ml-2 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-600"
                    >
                      Close
                    </button>
                  </div>
                </div>
              )}
              
              {/* Approval tab */}
              {activeTab === 'approval' && (
                <div className="p-4">
                  <h2 className="text-xl font-semibold mb-3">
                    Approve or Revise: {selectedCampaign.title}
                  </h2>
                  
                  {updateStatus?.loading ? (
                    <div className="flex justify-center py-6">
                      <p>Updating campaign...</p>
                    </div>
                  ) : updateStatus?.success ? (
                    <div className="bg-green-900 border border-green-700 text-green-200 px-4 py-3 rounded mb-4">
                      {updateStatus.message}
                    </div>
                  ) : updateStatus?.error ? (
                    <div className="bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded mb-4">
                      {updateStatus.message}
                    </div>
                  ) : (
                    <>
                      <div className="mb-4">
                        <label className="block font-semibold mb-2">Client Notes:</label>
                        <textarea
                          className="w-full p-3 rounded bg-gray-800 border border-gray-700 text-white"
                          rows={6}
                          value={feedback}
                          onChange={(e) => setFeedback(e.target.value)}
                          placeholder="Enter your feedback or revision requests here..."
                        />
                      </div>
                      
                      <div className="flex flex-col sm:flex-row gap-3">
                        <button
                          onClick={() => handleApproval(true)}
                          className="py-3 bg-green-700 text-white rounded hover:bg-green-600 flex-1"
                        >
                          Approve Campaign
                        </button>
                        <button
                          onClick={() => handleApproval(false)}
                          className="py-3 bg-yellow-700 text-white rounded hover:bg-yellow-600 flex-1"
                        >
                          Request Revisions
                        </button>
                      </div>
                      
                      <div className="mt-4 flex justify-end">
                        <button
                          onClick={() => setActiveTab('details')}
                          className="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-600"
                        >
                          Back to Details
                        </button>
                      </div>
                    </>
                  )}
                </div>
              )}
            </div>
          )}
        </div>
      );
    };

    // Render the app
    ReactDOM.render(
      <CampaignCalendar />,
      document.getElementById('root')
    );
  </script>
</body>
</html>
