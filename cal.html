<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campaign Approval Calendar</title>
  <!-- Include React and ReactDOM -->
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <!-- Include Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Include Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Include Lodash -->
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <style>
    body {
      background-color: #f3f4f6;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
  </style>
</head>
<body>
  <div id="root" class="min-h-screen py-8"></div>

  <script type="text/babel">
    // CampaignCalendar component
    import React, { useState, useEffect } from 'react';
    import _ from 'lodash';

    const CampaignCalendar = () => {
      const [campaigns, setCampaigns] = useState([]);
      const [selectedCampaign, setSelectedCampaign] = useState(null);
      const [feedback, setFeedback] = useState('');
      const [loading, setLoading] = useState(true);
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const [selectedDate, setSelectedDate] = useState(null);
      const [updateStatus, setUpdateStatus] = useState(null);

      // Your webhook URLs
      const fetchCampaignsUrl = 'https://hook.us2.make.com/dlcqdia9qozi8lca39jytiu27xrf1t1l';
      const updateCampaignUrl = 'https://hook.us2.make.com/wem64vvx9irk7tys6itjpyt27bqorbvg';

      useEffect(() => {
        fetchCampaigns();
      }, []);

      const fetchCampaigns = async () => {
        try {
          setLoading(true);
          const response = await fetch(fetchCampaignsUrl);
          
          if (!response.ok) throw new Error('Failed to fetch campaigns');
          const data = await response.json();
          
          // Format campaigns for calendar display
          const formattedCampaigns = data.map(record => ({
            id: record.id,
            title: record.fields.Tasks || 'Untitled Campaign',
            start: new Date(record.fields['Send Date']),
            end: new Date(record.fields['Send Date']),
            description: record.fields.Notes || '',
            status: record.fields.Stage || 'pending',
            clientId: record.fields.CLIENT || '',
            feedback: record.fields.Notes || ''
          }));
          
          setCampaigns(formattedCampaigns);
        } catch (error) {
          console.error('Error fetching campaigns:', error);
        } finally {
          setLoading(false);
        }
      };

      const handleSelectCampaign = (campaign) => {
        setSelectedCampaign(campaign);
        setFeedback(campaign.feedback || '');
        setUpdateStatus(null);
      };

      const handleApproval = async (approved) => {
        try {
          setUpdateStatus({ loading: true, error: null });
          const response = await fetch(updateCampaignUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              campaignId: selectedCampaign.id,
              approved: approved,
              feedback: feedback
            })
          });
          
          if (!response.ok) throw new Error('Failed to update campaign status');
          
          // Update local state
          setCampaigns(campaigns.map(campaign => 
            campaign.id === selectedCampaign.id 
              ? { 
                  ...campaign, 
                  status: approved ? 'Approved' : 'Needs Revision', 
                  feedback 
                } 
              : campaign
          ));
          
          setUpdateStatus({ 
            loading: false, 
            success: true, 
            message: `Campaign ${approved ? 'approved' : 'sent for revision'} successfully!` 
          });
          
          // Clear selected campaign after a delay to show success message
          setTimeout(() => {
            setSelectedCampaign(null);
            setFeedback('');
            setUpdateStatus(null);
          }, 2000);
          
        } catch (error) {
          console.error('Error updating approval status:', error);
          setUpdateStatus({ 
            loading: false, 
            error: true, 
            message: error.message || 'Error updating campaign status' 
          });
        }
      };

      const getStatusColor = (status) => {
        if (!status) return 'bg-gray-600';
        
        const statusLower = status.toLowerCase();
        if (statusLower.includes('approved')) return 'bg-green-500';
        if (statusLower.includes('rejected')) return 'bg-red-500';
        if (statusLower.includes('revision') || statusLower.includes('needs')) return 'bg-yellow-500';
        if (statusLower.includes('design') || statusLower.includes('qa')) return 'bg-blue-400';
        if (statusLower.includes('ready')) return 'bg-purple-500';
        return 'bg-gray-600';
      };

      // Calendar navigation
      const prevMonth = () => {
        setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1));
      };

      const nextMonth = () => {
        setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1));
      };

      // Generate calendar days
      const getDaysInMonth = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        
        // Get day of week of first day (0 = Sunday)
        const firstDayOfWeek = firstDay.getDay();
        
        // Array for all days to display
        const days = [];
        
        // Add empty slots for days before first of month
        for (let i = 0; i < firstDayOfWeek; i++) {
          days.push({ date: null, isCurrentMonth: false });
        }
        
        // Add all days in month
        for (let i = 1; i <= lastDay.getDate(); i++) {
          days.push({ 
            date: new Date(year, month, i),
            isCurrentMonth: true 
          });
        }
        
        return days;
      };

      const days = getDaysInMonth(currentMonth);
      
      // Group campaigns by date for calendar display
      const campaignsByDate = _.groupBy(campaigns, campaign => 
        campaign.start.toDateString()
      );

      // Get day name headers
      const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

      // Format date for display
      const formatDate = (date) => {
        if (!date) return '';
        return date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          year: 'numeric'
        });
      };

      return (
        <div className="container mx-auto p-4 bg-gray-100">
          <div className="bg-gray-700 rounded-lg shadow-lg overflow-hidden">
            <div className="p-6 bg-gray-800 text-white">
              <h1 className="text-2xl font-bold text-center">CONTENT CALENDAR</h1>
            </div>
            
            {loading ? (
              <div className="flex justify-center items-center h-64 bg-gray-700 text-white">
                <p>Loading campaigns...</p>
              </div>
            ) : (
              <div className="p-6 bg-gray-700">
                <div className="flex justify-between items-center mb-4 text-white">
                  <button onClick={prevMonth} className="px-4 py-2 bg-gray-600 rounded hover:bg-gray-500">
                    &lt; Previous
                  </button>
                  <h2 className="text-xl font-semibold">
                    {currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}
                  </h2>
                  <div className="flex space-x-2">
                    <button onClick={nextMonth} className="px-4 py-2 bg-gray-600 rounded hover:bg-gray-500">
                      Next &gt;
                    </button>
                    <button className="px-4 py-2 bg-green-500 rounded hover:bg-green-400">
                      + Add
                    </button>
                  </div>
                </div>
                
                {/* Calendar grid */}
                <div className="grid grid-cols-7 gap-1 rounded-lg overflow-hidden">
                  {/* Weekday headers */}
                  {weekdays.map(day => (
                    <div key={day} className="p-2 bg-gray-600 text-center font-semibold text-white">
                      {day}
                    </div>
                  ))}
                  
                  {/* Calendar days */}
                  {days.map((day, index) => (
                    <div 
                      key={index}
                      className={`min-h-28 p-1 ${
                        day.isCurrentMonth ? 'bg-gray-800' : 'bg-gray-900'
                      } ${
                        selectedDate && day.date && selectedDate.toDateString() === day.date.toDateString() 
                          ? 'ring-2 ring-blue-400' 
                          : ''
                      } text-white`}
                      onClick={() => day.date && setSelectedDate(day.date)}
                    >
                      {day.date && (
                        <>
                          <div className="text-right text-sm p-1">
                            {day.date.getDate()}
                          </div>
                          <div className="mt-1">
                            {campaignsByDate[day.date.toDateString()]?.map(campaign => (
                              <div 
                                key={campaign.id}
                                className={`mb-1 p-1 text-xs text-white rounded cursor-pointer truncate ${getStatusColor(campaign.status)}`}
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleSelectCampaign(campaign);
                                }}
                              >
                                {campaign.title}
                              </div>
                            ))}
                          </div>
                        </>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
          
          {selectedCampaign && (
            <div className="mt-4 bg-gray-800 text-white rounded-lg shadow-lg p-4">
              <h2 className="text-xl font-semibold mb-2">{selectedCampaign.title}</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <p className="mb-2">
                    <span className="font-semibold">Date:</span> {formatDate(selectedCampaign.start)}
                  </p>
                  <p className="mb-2">
                    <span className="font-semibold">Status:</span> 
                    <span className={`ml-2 px-2 py-1 rounded text-white ${getStatusColor(selectedCampaign.status)}`}>
                      {selectedCampaign.status}
                    </span>
                  </p>
                </div>
                <div>
                  <p className="mb-2">
                    <span className="font-semibold">Client:</span> {selectedCampaign.clientId}
                  </p>
                  {selectedCampaign.description && (
                    <p className="mb-2">
                      <span className="font-semibold">Campaign Details:</span> {selectedCampaign.description}
                    </p>
                  )}
                </div>
              </div>
              
              {selectedCampaign.feedback && selectedCampaign.feedback !== feedback && (
                <div className="mb-4 p-3 bg-gray-700 border border-gray-600 rounded">
                  <p className="font-semibold text-sm text-gray-300">Previous Notes:</p>
                  <p className="text-sm">{selectedCampaign.feedback}</p>
                </div>
              )}
                  
              {updateStatus?.loading ? (
                <div className="flex justify-center py-2">
                  <p>Updating campaign...</p>
                </div>
              ) : updateStatus?.success ? (
                <div className="bg-green-800 border border-green-600 text-green-200 px-4 py-2 rounded mb-4">
                  {updateStatus.message}
                </div>
              ) : updateStatus?.error ? (
                <div className="bg-red-800 border border-red-600 text-red-200 px-4 py-2 rounded mb-4">
                  {updateStatus.message}
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="border-t border-gray-600 pt-4">
                    <label className="block font-semibold mb-2">Client Notes:</label>
                    <textarea
                      className="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white"
                      rows={4}
                      value={feedback}
                      onChange={(e) => setFeedback(e.target.value)}
                      placeholder="Enter your feedback or revision requests here..."
                      disabled={updateStatus?.loading}
                    />
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <button
                      onClick={() => handleApproval(true)}
                      className="py-2 bg-green-600 text-white rounded hover:bg-green-500"
                    >
                      Approve
                    </button>
                    <button
                      onClick={() => handleApproval(false)}
                      className="py-2 bg-yellow-600 text-white rounded hover:bg-yellow-500"
                    >
                      Revise
                    </button>
                  </div>
                  
                  <button
                    onClick={() => {
                      setSelectedCampaign(null);
                      setFeedback('');
                    }}
                    className="w-full py-2 bg-gray-600 text-white rounded hover:bg-gray-500"
                  >
                    Cancel
                  </button>
                </div>
              )}
            </div>
          )}
        </div>
      );
    };

    // Render the app
    ReactDOM.render(
      <CampaignCalendar />,
      document.getElementById('root')
    );
  </script>
</body>
</html>
